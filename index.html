<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">تسجيل الدخول - الأمانة ماركت </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .glass-dark {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .google-btn {
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .google-btn:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10B981, #059669);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #EF4444, #DC2626);
        }
        
        .notification.info {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
        }
        
        .input-group {
            position: relative;
        }
        
        .input-group input {
            padding-right: 3rem;
        }
        
        .input-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.6);
        }
        
        .password-toggle {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .password-toggle:hover {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .container-padding {
            padding: 0 1rem;
        }
        
        @media (min-width: 640px) {
            .container-padding {
                padding: 0 1.5rem;
            }
        }
        
        @media (max-width: 640px) {
            .notification {
                right: 10px;
                left: 10px;
                transform: translateY(-100px);
            }
            
            .notification.show {
                transform: translateY(0);
            }
        }

        .order-status-pending {
            background: linear-gradient(135deg, #F59E0B, #D97706);
        }
        
        .order-status-confirmed {
            background: linear-gradient(135deg, #10B981, #059669);
        }
        
        .order-status-cancelled {
            background: linear-gradient(135deg, #EF4444, #DC2626);
        }
        
        .order-status-delivered {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 flex items-center justify-center p-4">
    
    <!-- Login Container -->
    <div id="loginContainer" class="glass-dark p-8 rounded-2xl max-w-md w-full mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="mb-6">
                <i class="fas fa-store text-6xl text-white mb-4"></i>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">مرحباً بك</h1>
            <p class="text-gray-300">سجل دخولك للمتابعة</p>
        </div>
        
        <!-- Login Form -->
        <div class="space-y-6">
            <!-- Google Sign In Button -->
            <button id="googleSignInBtn" class="google-btn w-full bg-white p-4 rounded-lg text-gray-700 hover:bg-gray-50 transition-all border border-gray-300 flex items-center justify-center gap-3 font-medium">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                تسجيل الدخول بحساب جوجل
            </button>
            
            <!-- Divider -->
            <div class="flex items-center gap-4">
                <div class="flex-1 h-px bg-white bg-opacity-30"></div>
                <span class="text-gray-300 text-sm">أو</span>
                <div class="flex-1 h-px bg-white bg-opacity-30"></div>
            </div>
            
            <!-- Email Input -->
            <div class="input-group">
                <input type="email" id="loginEmail" placeholder="البريد الإلكتروني" 
                       class="w-full p-4 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                <i class="fas fa-envelope input-icon"></i>
            </div>
            
            <!-- Password Input -->
            <div class="input-group">
                <input type="password" id="loginPassword" placeholder="كلمة المرور" 
                       class="w-full p-4 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                <i class="fas fa-lock input-icon"></i>
                <i class="fas fa-eye password-toggle" id="togglePassword"></i>
            </div>
            
            <!-- Action Buttons -->
            <div class="space-y-3">
                <button id="loginSubmitBtn" class="w-full bg-gradient-to-r from-green-500 to-green-600 p-4 rounded-lg text-white hover:from-green-600 hover:to-green-700 transition-all font-medium shadow-lg">
                    <i class="fas fa-sign-in-alt ml-2"></i>
                    تسجيل الدخول
                </button>
                
                <button id="registerBtn" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 p-4 rounded-lg text-white hover:from-blue-600 hover:to-blue-700 transition-all font-medium shadow-lg">
                    <i class="fas fa-user-plus ml-2"></i>
                    إنشاء حساب جديد
                </button>
            </div>
            
            <!-- Loading Indicator -->
            <div id="loginLoading" class="hidden text-center">
                <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-blue-500">
                    <div class="loading-spinner mr-3"></div>
                    جاري تسجيل الدخول...
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="mt-8 text-center">
            <p class="text-gray-400 text-sm">
                بالمتابعة، أنت توافق على 
                <a href="#" class="text-blue-400 hover:text-blue-300 transition-colors">شروط الاستخدام</a>
                و
                <a href="#" class="text-blue-400 hover:text-blue-300 transition-colors">سياسة الخصوصية</a>
            </p>
        </div>
    </div>

    <!-- Main App (Hidden Initially) -->
    <div id="mainApp" class="hidden w-full min-h-screen">
        <!-- Header -->
        <header class="glass container-padding m-2 sm:m-4 rounded-2xl">
            <div class="header-content flex justify-between items-center p-4">
                <div class="flex items-center gap-2 sm:gap-4">
                    <i class="fas fa-store text-2xl sm:text-3xl text-white"></i>
                    <div>
                        <h1 id="storeNameHeader" class="text-lg sm:text-2xl font-bold text-white">الأمانة ماركت </h1>
                        <p class="text-gray-200 text-xs sm:text-sm">أهلاً <span id="userNameDisplay"></span></p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 sm:gap-4">
                    <!-- User Profile Picture -->
                    <div id="userProfileContainer" class="hidden">
                        <img id="userProfilePic" src="" alt="صورة المستخدم" class="w-10 h-10 rounded-full border-2 border-white border-opacity-50">
                    </div>
                    
                    <!-- Cart Button -->
                    <button id="cartBtn" class="relative glass px-3 sm:px-4 py-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20 transition-all">
                        <i class="fas fa-shopping-cart text-lg sm:text-xl"></i>
                        <span id="cartBadge" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">0</span>
                    </button>
                    
                    <!-- Logout Button -->
                    <button id="logoutBtn" class="bg-red-500 px-3 sm:px-4 py-2 rounded-lg text-white hover:bg-red-600 transition-all text-sm sm:text-base">
                        <i class="fas fa-sign-out-alt ml-1 sm:ml-2"></i>
                        <span class="hidden sm:inline">خروج</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="glass container-padding m-2 sm:m-4 rounded-2xl">
            <div class="text-center p-4">
                <h2 class="text-xl sm:text-2xl font-bold text-white">
                    <i class="fas fa-th-large ml-2"></i>
                    <span>لوحة التحكم - الأقسام</span>
                </h2>
                <p class="text-gray-200 text-sm mt-2">اختر القسم المطلوب للانتقال إليه</p>
            </div>
        </nav>

        <!-- Categories Page -->
        <div id="categoriesPage" class="container-padding">
            <!-- Dashboard Stats (Admin Only) -->
            <div id="dashboardStats" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 sm:gap-4 mb-6">
                <!-- Stats will be populated here -->
            </div>
            
            <div id="categoriesGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-8 gap-3 sm:gap-4 md:gap-6">
                <!-- Categories will be populated here -->
            </div>
        </div>

        <!-- Products Page -->
        <div id="productsPage" class="hidden container-padding">
            <!-- Back Button and Category Header -->
            <div class="glass p-4 rounded-2xl mb-6">
                <div class="flex items-center justify-between">
                    <button id="backToCategoriesBtn" class="flex items-center gap-2 text-white hover:text-blue-300 transition-colors">
                        <i class="fas fa-arrow-right text-xl"></i>
                        <span class="font-medium">العودة للأقسام</span>
                    </button>
                    <div class="text-center">
                        <h2 id="categoryTitle" class="text-xl sm:text-2xl font-bold text-white"></h2>
                        <p id="categorySubtitle" class="text-gray-200 text-sm"></p>
                    </div>
                    <div></div>
                </div>
            </div>
            
            <!-- Products Grid -->
            <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4 md:gap-6">
                <!-- Products will be populated here -->
            </div>
        </div>

        <!-- Admin Settings Page -->
        <div id="adminSettingsPage" class="hidden container-padding">
            <!-- Back Button and Settings Header -->
            <div class="glass p-4 rounded-2xl mb-6">
                <div class="flex items-center justify-between">
                    <button id="backFromSettingsBtn" class="flex items-center gap-2 text-white hover:text-blue-300 transition-colors">
                        <i class="fas fa-arrow-right text-xl"></i>
                        <span class="font-medium">العودة للأقسام</span>
                    </button>
                    <div class="text-center">
                        <h2 class="text-xl sm:text-2xl font-bold text-white">
                            <i class="fas fa-crown text-yellow-400 ml-2"></i>
                            إعدادات المدير
                        </h2>
                        <p class="text-gray-200 text-sm">تحكم في إعدادات النظام</p>
                    </div>
                    <div></div>
                </div>
            </div>
            
            <!-- Settings Content -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Store Name Setting -->
                <div class="glass p-6 rounded-2xl">
                    <div class="text-center mb-4">
                        <i class="fas fa-store text-3xl text-yellow-400 mb-3"></i>
                        <h3 class="text-lg font-bold text-white">اسم المتجر</h3>
                        <p class="text-gray-300 text-sm">تغيير اسم المتجر في جميع أنحاء الموقع</p>
                    </div>
                    <div class="space-y-3">
                        <input type="text" id="storeNameSetting" placeholder="اسم المتجر" 
                               class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-yellow-400 focus:outline-none transition-all">
                        <button id="updateStoreNameBtn" class="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 p-3 rounded-lg text-white hover:from-yellow-600 hover:to-yellow-700 transition-all font-medium">
                            <i class="fas fa-save ml-2"></i>
                            تحديث اسم المتجر
                        </button>
                    </div>
                </div>

                <!-- Admin Email Setting -->
                <div class="glass p-6 rounded-2xl">
                    <div class="text-center mb-4">
                        <i class="fas fa-envelope text-3xl text-blue-400 mb-3"></i>
                        <h3 class="text-lg font-bold text-white">إيميل المدير</h3>
                        <p class="text-gray-300 text-sm">تحديد الإيميل الذي يحصل على صلاحيات المدير</p>
                    </div>
                    <div class="space-y-3">
                        <input type="email" id="adminEmailSetting" placeholder="admin@store.com" 
                               class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                        <button id="updateAdminEmailBtn" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 p-3 rounded-lg text-white hover:from-blue-600 hover:to-blue-700 transition-all font-medium">
                            <i class="fas fa-save ml-2"></i>
                            حفظ التغييرات
                        </button>
                    </div>
                </div>

                <!-- Admin Password Setting -->
                <div class="glass p-6 rounded-2xl">
                    <div class="text-center mb-4">
                        <i class="fas fa-key text-3xl text-purple-400 mb-3"></i>
                        <h3 class="text-lg font-bold text-white">كلمة مرور المدير</h3>
                        <p class="text-gray-300 text-sm">تغيير كلمة مرور دخول المدير</p>
                    </div>
                    <div class="space-y-3">
                        <input type="password" id="adminPasswordSetting" placeholder="كلمة المرور الجديدة" 
                               class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-purple-400 focus:outline-none transition-all">
                        <button id="updateAdminPasswordBtn" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 p-3 rounded-lg text-white hover:from-purple-600 hover:to-purple-700 transition-all font-medium">
                            <i class="fas fa-save ml-2"></i>
                            تحديث كلمة المرور
                        </button>
                    </div>
                </div>

                <!-- Wallet Settings -->
                <div class="glass p-6 rounded-2xl">
                    <div class="text-center mb-4">
                        <i class="fas fa-wallet text-3xl text-green-400 mb-3"></i>
                        <h3 class="text-lg font-bold text-white">إعدادات المحفظة</h3>
                        <p class="text-gray-300 text-sm">رقم المحفظة ومقدم الخدمة لاستقبال المدفوعات</p>
                    </div>
                    <div class="space-y-3">
                        <select id="walletProviderSetting" class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white border border-white border-opacity-30 focus:border-green-400 focus:outline-none transition-all">
                            <option value="vodafone">فودافون كاش</option>
                            <option value="etisalat">اتصالات كاش</option>
                            <option value="orange">أورانج كاش</option>
                        </select>
                        <input type="tel" id="walletNumberSetting" placeholder="01xxxxxxxxx" 
                               class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-green-400 focus:outline-none transition-all">
                        <button id="updateWalletBtn" class="w-full bg-gradient-to-r from-green-500 to-green-600 p-3 rounded-lg text-white hover:from-green-600 hover:to-green-700 transition-all font-medium">
                            <i class="fas fa-save ml-2"></i>
                            تحديث المحفظة
                        </button>
                    </div>
                </div>

                <!-- Orders Management -->
                <div class="glass p-6 rounded-2xl">
                    <div class="text-center mb-4">
                        <i class="fas fa-clipboard-list text-3xl text-cyan-400 mb-3"></i>
                        <h3 class="text-lg font-bold text-white">إدارة الطلبات</h3>
                        <p class="text-gray-300 text-sm">متابعة وإدارة طلبات العملاء</p>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between text-white">
                            <span>إجمالي الطلبات:</span>
                            <span class="font-bold text-cyan-400" id="totalOrdersCount">0</span>
                        </div>
                        <div class="flex justify-between text-white">
                            <span>طلبات معلقة:</span>
                            <span class="font-bold text-yellow-400" id="pendingOrdersCount">0</span>
                        </div>
                        <div class="flex justify-between text-white">
                            <span>طلبات مؤكدة:</span>
                            <span class="font-bold text-green-400" id="confirmedOrdersCount">0</span>
                        </div>
                        <button id="manageOrdersBtn" class="w-full bg-gradient-to-r from-cyan-500 to-cyan-600 p-3 rounded-lg text-white hover:from-cyan-600 hover:to-cyan-700 transition-all font-medium">
                            <i class="fas fa-list ml-2"></i>
                            عرض جميع الطلبات
                        </button>
                    </div>
                </div>

                <!-- Categories Management -->
                <div class="glass p-6 rounded-2xl">
                    <div class="text-center mb-4">
                        <i class="fas fa-th-large text-3xl text-indigo-400 mb-3"></i>
                        <h3 class="text-lg font-bold text-white">إدارة الأقسام</h3>
                        <p class="text-gray-300 text-sm">إضافة وتعديل وحذف أقسام المتجر</p>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between text-white">
                            <span>عدد الأقسام:</span>
                            <span class="font-bold text-indigo-400" id="categoriesCountManage">0</span>
                        </div>
                        <button id="manageCategoriesBtn" class="w-full bg-gradient-to-r from-indigo-500 to-indigo-600 p-3 rounded-lg text-white hover:from-indigo-600 hover:to-indigo-700 transition-all font-medium">
                            <i class="fas fa-edit ml-2"></i>
                            إدارة الأقسام
                        </button>
                    </div>
                </div>

                <!-- Products Management -->
                <div class="glass p-6 rounded-2xl">
                    <div class="text-center mb-4">
                        <i class="fas fa-boxes text-3xl text-teal-400 mb-3"></i>
                        <h3 class="text-lg font-bold text-white">إدارة المنتجات</h3>
                        <p class="text-gray-300 text-sm">إضافة وتعديل وحذف منتجات المتجر</p>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between text-white">
                            <span>إجمالي المنتجات:</span>
                            <span class="font-bold text-teal-400" id="productsCountManage">0</span>
                        </div>
                        <div class="flex justify-between text-white">
                            <span>منتجات نفدت:</span>
                            <span class="font-bold text-red-400" id="outOfStockCount">0</span>
                        </div>
                        <button id="manageProductsBtn" class="w-full bg-gradient-to-r from-teal-500 to-teal-600 p-3 rounded-lg text-white hover:from-teal-600 hover:to-teal-700 transition-all font-medium">
                            <i class="fas fa-edit ml-2"></i>
                            إدارة المنتجات
                        </button>
                    </div>
                </div>

                <!-- Notifications Settings -->
                <div class="glass p-6 rounded-2xl">
                    <div class="text-center mb-4">
                        <i class="fas fa-bell text-3xl text-orange-400 mb-3"></i>
                        <h3 class="text-lg font-bold text-white">إعدادات الإشعارات</h3>
                        <p class="text-gray-300 text-sm">تفعيل الإشعارات والواتساب للطلبات</p>
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-white">إشعار الطلبات الجديدة:</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="newOrderNotifications" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-white">صوت الإشعار:</span>
                            <select id="notificationSound" class="bg-white bg-opacity-20 text-white border border-white border-opacity-30 rounded px-3 py-1 text-sm">
                                <option value="beep">صوت عادي</option>
                                <option value="chime">جرس</option>
                                <option value="alert">تنبيه</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-white text-sm font-medium mb-2">رقم الواتساب للإشعارات:</label>
                            <input type="tel" id="whatsappNumber" placeholder="201012345678" 
                                   class="w-full p-2 rounded bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-orange-400 focus:outline-none transition-all text-sm">
                            <p class="text-gray-400 text-xs mt-1">أدخل الرقم بدون + أو 00</p>
                        </div>
                        <button id="testNotificationBtn" class="w-full bg-gradient-to-r from-orange-500 to-orange-600 p-3 rounded-lg text-white hover:from-orange-600 hover:to-orange-700 transition-all font-medium">
                            <i class="fas fa-volume-up ml-2"></i>
                            تجربة الإشعار
                        </button>
                    </div>
                </div>

                <!-- Store Statistics -->
                <div class="glass p-6 rounded-2xl">
                    <div class="text-center mb-4">
                        <i class="fas fa-chart-bar text-3xl text-pink-400 mb-3"></i>
                        <h3 class="text-lg font-bold text-white">إحصائيات المتجر</h3>
                        <p class="text-gray-300 text-sm">معلومات عامة عن المتجر</p>
                    </div>
                    <div class="space-y-3 text-white">
                        <div class="flex justify-between">
                            <span>عدد الأقسام:</span>
                            <span class="font-bold text-blue-400" id="categoriesCount">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>عدد المنتجات:</span>
                            <span class="font-bold text-green-400" id="productsCount">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>المنتجات المتاحة:</span>
                            <span class="font-bold text-yellow-400" id="availableProductsCount">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let currentUser = null;
        let isAdmin = false;
        let cart = [];
        let currentPage = 'categories';
        let selectedCategory = null;
        let adminEmail = 'ahmedmoradm70@gmail.com';
        let adminPassword = '15926357';
        let storeName = 'الأمانة ماركت ';
        let walletNumber = '01092241309';
        let walletProvider = 'vodafone';

        // Database System
        let orders = [];
        let orderIdCounter = 1;

        // Notification Settings
        let notificationsEnabled = true;
        let notificationSound = 'beep';
        let whatsappNumber = '';

        // Extended color palette for categories
        const categoryColors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F',
            '#BB8FCE', '#85C1E9', '#F8C471', '#82E0AA', '#F1948A', '#85C1E9', '#D7BDE2', '#A9DFBF',
            '#F9E79F', '#AED6F1', '#D5A6BD', '#A3E4D7', '#FAD7A0', '#D2B4DE', '#A9CCE3', '#ABEBC6',
            '#F5B7B1', '#AED6F1', '#E8DAEF', '#A3E4D7', '#FADBD8', '#D4EDDA', '#FFF3CD', '#D1ECF1',
            '#8B0000', '#006400', '#000080', '#8B008B', '#FF8C00', '#2F4F4F', '#8B4513', '#483D8B',
            '#B22222', '#228B22', '#4169E1', '#9932CC', '#FF4500', '#2E8B57', '#D2691E', '#6A5ACD',
            '#DC143C', '#32CD32', '#1E90FF', '#BA55D3', '#FF6347', '#3CB371', '#CD853F', '#9370DB'
        ];

        // Audio Context for notifications
        let audioContext = null;
        
        // Initialize audio context
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Play notification sound
        function playNotificationSound(type = 'beep') {
            if (!notificationsEnabled) return;
            
            try {
                initAudioContext();
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Different sound frequencies for different notification types
                const frequencies = {
                    'beep': [800, 600],
                    'chime': [523, 659, 784],
                    'alert': [1000, 800, 1000]
                };
                
                const freq = frequencies[type] || frequencies['beep'];
                let currentTime = audioContext.currentTime;
                
                freq.forEach((frequency, index) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    
                    osc.frequency.setValueAtTime(frequency, currentTime);
                    gain.gain.setValueAtTime(0.1, currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, currentTime + 0.3);
                    
                    osc.start(currentTime);
                    osc.stop(currentTime + 0.3);
                    
                    currentTime += 0.4;
                });
                
            } catch (error) {
                console.log('Audio notification not supported');
            }
        }

        // User database simulation
        let registeredUsers = [
            { email: 'ahmed@gmail.com', password: '123456', name: 'أحمد محمد' },
            { email: 'sara@gmail.com', password: '123456', name: 'سارة أحمد' },
            { email: 'mohammed@gmail.com', password: '123456', name: 'محمد علي' }
        ];

        // Sample Data
        let categories = [
            { id: 1, name: 'الجبن والألبان', icon: 'fas fa-cheese', color: '#FFD700' },
            { id: 2, name: 'البقوليات', icon: 'fas fa-seedling', color: '#8B4513' },
            { id: 3, name: 'التسالي', icon: 'fas fa-cookie', color: '#FF6347' },
            { id: 4, name: 'المعلبات', icon: 'fas fa-box', color: '#32CD32' },
            { id: 5, name: 'العطارة', icon: 'fas fa-leaf', color: '#9370DB' },
            { id: 6, name: 'المنظفات', icon: 'fas fa-spray-can', color: '#00CED1' },
            { id: 7, name: 'الأدوات المدرسية', icon: 'fas fa-graduation-cap', color: '#FF4500' }
        ];

        let products = [
            { id: 1, name: 'جبنة بيضاء', price: 45.00, categoryId: 1, stock: 20, discount: 0, image: '🧀' },
            { id: 2, name: 'حليب طازج', price: 25.00, categoryId: 1, stock: 15, discount: 10, image: '🥛' },
            { id: 3, name: 'لبنة', price: 30.00, categoryId: 1, stock: 25, discount: 0, image: '🥛' },
            { id: 4, name: 'زبدة', price: 35.00, categoryId: 1, stock: 18, discount: 5, image: '🧈' },
            { id: 5, name: 'عدس أحمر', price: 35.00, categoryId: 2, stock: 30, discount: 0, image: '🌾' },
            { id: 6, name: 'حمص حب', price: 40.00, categoryId: 2, stock: 25, discount: 15, image: '🌾' },
            { id: 7, name: 'فول مدمس', price: 28.00, categoryId: 2, stock: 35, discount: 0, image: '🌾' },
            { id: 8, name: 'فاصوليا بيضاء', price: 32.00, categoryId: 2, stock: 22, discount: 8, image: '🌾' },
            { id: 9, name: 'شيبس', price: 15.00, categoryId: 3, stock: 40, discount: 0, image: '🍟' },
            { id: 10, name: 'مكسرات مشكلة', price: 80.00, categoryId: 3, stock: 20, discount: 20, image: '🥜' },
            { id: 11, name: 'بسكويت', price: 12.00, categoryId: 3, stock: 50, discount: 0, image: '🍪' },
            { id: 12, name: 'شوكولاتة', price: 25.00, categoryId: 3, stock: 30, discount: 10, image: '🍫' },
            { id: 13, name: 'تونة معلبة', price: 18.00, categoryId: 4, stock: 45, discount: 0, image: '🥫' },
            { id: 14, name: 'ذرة معلبة', price: 12.00, categoryId: 4, stock: 38, discount: 5, image: '🥫' },
            { id: 15, name: 'طماطم معلبة', price: 15.00, categoryId: 4, stock: 42, discount: 0, image: '🥫' },
            { id: 16, name: 'زيت زيتون', price: 65.00, categoryId: 5, stock: 15, discount: 12, image: '🫒' },
            { id: 17, name: 'عسل طبيعي', price: 85.00, categoryId: 5, stock: 12, discount: 0, image: '🍯' },
            { id: 18, name: 'زعتر', price: 22.00, categoryId: 5, stock: 28, discount: 0, image: '🌿' },
            { id: 19, name: 'صابون غسيل', price: 8.00, categoryId: 6, stock: 60, discount: 0, image: '🧼' },
            { id: 20, name: 'منظف أرضيات', price: 18.00, categoryId: 6, stock: 35, discount: 15, image: '🧽' },
            { id: 21, name: 'قلم رصاص', price: 2.50, categoryId: 7, stock: 100, discount: 0, image: '✏️' },
            { id: 22, name: 'دفتر مدرسي', price: 12.00, categoryId: 7, stock: 50, discount: 10, image: '📓' },
            { id: 23, name: 'مسطرة', price: 5.00, categoryId: 7, stock: 40, discount: 0, image: '📏' },
            { id: 24, name: 'ممحاة', price: 3.00, categoryId: 7, stock: 80, discount: 0, image: '🧽' },
            { id: 25, name: 'مقص', price: 15.00, categoryId: 7, stock: 25, discount: 5, image: '✂️' },
            { id: 26, name: 'صمغ', price: 8.00, categoryId: 7, stock: 35, discount: 0, image: '🧴' }
        ];

        // DOM Elements
        const loginContainer = document.getElementById('loginContainer');
        const mainApp = document.getElementById('mainApp');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const loginSubmitBtn = document.getElementById('loginSubmitBtn');
        const registerBtn = document.getElementById('registerBtn');
        const togglePasswordBtn = document.getElementById('togglePassword');
        const loginLoading = document.getElementById('loginLoading');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const userNameDisplay = document.getElementById('userNameDisplay');
        const logoutBtn = document.getElementById('logoutBtn');
        const cartBadge = document.getElementById('cartBadge');

        // Initialize
        init();

        function init() {
            loadFromLocalStorage();
            setupEventListeners();
        }

        // Auto-save system
        function saveToLocalStorage() {
            const data = {
                categories,
                products,
                orders,
                orderIdCounter,
                adminEmail,
                adminPassword,
                storeName,
                walletNumber,
                walletProvider,
                registeredUsers,
                notificationsEnabled,
                notificationSound,
                whatsappNumber
            };
            try {
                localStorage.setItem('bakalatAlhayData', JSON.stringify(data));
                console.log('Data saved successfully');
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('bakalatAlhayData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.categories) categories = data.categories;
                    if (data.products) products = data.products;
                    if (data.orders) orders = data.orders;
                    if (data.orderIdCounter) orderIdCounter = data.orderIdCounter;
                    if (data.adminEmail) adminEmail = data.adminEmail;
                    if (data.adminPassword) adminPassword = data.adminPassword;
                    if (data.storeName) storeName = data.storeName;
                    if (data.walletNumber) walletNumber = data.walletNumber;
                    if (data.walletProvider) walletProvider = data.walletProvider;
                    if (data.registeredUsers) registeredUsers = data.registeredUsers;
                    if (data.notificationsEnabled !== undefined) notificationsEnabled = data.notificationsEnabled;
                    if (data.notificationSound) notificationSound = data.notificationSound;
                    if (data.whatsappNumber) whatsappNumber = data.whatsappNumber;
                    console.log('Data loaded successfully');
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function setupEventListeners() {
            // Google Sign In
            googleSignInBtn.addEventListener('click', handleGoogleSignIn);
            
            // Email/Password Login
            loginSubmitBtn.addEventListener('click', handleEmailLogin);
            
            // Register
            registerBtn.addEventListener('click', handleEmailRegister);
            
            // Password toggle
            togglePasswordBtn.addEventListener('click', togglePasswordVisibility);
            
            // Logout
            logoutBtn.addEventListener('click', handleLogout);
            
            // Cart button
            document.getElementById('cartBtn').addEventListener('click', showCart);
            
            // Navigation buttons
            document.getElementById('backToCategoriesBtn').addEventListener('click', () => navigateToPage('categories'));
            document.getElementById('backFromSettingsBtn').addEventListener('click', () => navigateToPage('categories'));
            
            // Admin settings buttons
            document.getElementById('updateStoreNameBtn').addEventListener('click', updateStoreName);
            document.getElementById('updateAdminEmailBtn').addEventListener('click', updateAdminEmail);
            document.getElementById('updateAdminPasswordBtn').addEventListener('click', updateAdminPassword);
            document.getElementById('updateWalletBtn').addEventListener('click', updateWalletSettings);
            document.getElementById('manageOrdersBtn').addEventListener('click', showOrdersManagementModal);
            document.getElementById('manageCategoriesBtn').addEventListener('click', showCategoriesManagementModal);
            document.getElementById('manageProductsBtn').addEventListener('click', showProductsManagementModal);
            
            // Notification settings
            document.getElementById('newOrderNotifications').addEventListener('change', updateNotificationSettings);
            document.getElementById('notificationSound').addEventListener('change', updateNotificationSettings);
            document.getElementById('whatsappNumber').addEventListener('input', updateNotificationSettings);
            document.getElementById('testNotificationBtn').addEventListener('click', testNotification);
            
            // Enter key login
            loginPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleEmailLogin();
            });
            loginEmail.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleEmailLogin();
            });
        }

        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('loginPassword');
            const toggleIcon = togglePasswordBtn;
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash password-toggle';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye password-toggle';
            }
        }

        function showLoading(show = true) {
            if (show) {
                loginLoading.classList.remove('hidden');
                googleSignInBtn.disabled = true;
                loginSubmitBtn.disabled = true;
                registerBtn.disabled = true;
                googleSignInBtn.style.opacity = '0.6';
                loginSubmitBtn.style.opacity = '0.6';
                registerBtn.style.opacity = '0.6';
            } else {
                loginLoading.classList.add('hidden');
                googleSignInBtn.disabled = false;
                loginSubmitBtn.disabled = false;
                registerBtn.disabled = false;
                googleSignInBtn.style.opacity = '1';
                loginSubmitBtn.style.opacity = '1';
                registerBtn.style.opacity = '1';
            }
        }

        async function handleGoogleSignIn() {
            try {
                showLoading(true);
                
                // Simulate Google Sign-In process
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Simulate successful Google login with random email
                const emails = ['ahmed@gmail.com', 'sara@gmail.com', 'mohammed@gmail.com', adminEmail];
                const randomEmail = emails[Math.floor(Math.random() * emails.length)];
                
                const userData = {
                    name: randomEmail === adminEmail ? 'المدير العام' : randomEmail.split('@')[0],
                    email: randomEmail,
                    photoURL: null,
                    isAdmin: randomEmail === adminEmail
                };
                
                handleLoginSuccess(userData);
                
            } catch (error) {
                console.error('Google Sign-In Error:', error);
                showNotification('حدث خطأ في تسجيل الدخول بجوجل ❌', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleEmailLogin() {
            const email = loginEmail.value.trim();
            const password = loginPassword.value.trim();

            if (!email || !password) {
                showNotification('يرجى ملء جميع الحقول! ⚠️', 'error');
                return;
            }

            if (!isValidEmail(email)) {
                showNotification('يرجى إدخال بريد إلكتروني صحيح! ⚠️', 'error');
                return;
            }

            try {
                showLoading(true);
                
                // Simulate login process
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Check if admin credentials
                if (email === adminEmail && password === adminPassword) {
                    const userData = {
                        name: 'المدير العام',
                        email: email,
                        photoURL: null,
                        isAdmin: true
                    };
                    handleLoginSuccess(userData);
                    return;
                }
                
                // Check registered users
                const user = registeredUsers.find(u => u.email === email && u.password === password);
                if (user) {
                    const userData = {
                        name: user.name,
                        email: user.email,
                        photoURL: null,
                        isAdmin: email === adminEmail
                    };
                    handleLoginSuccess(userData);
                } else {
                    // Check if email exists but wrong password
                    const emailExists = registeredUsers.find(u => u.email === email);
                    if (emailExists) {
                        showNotification('كلمة المرور غير صحيحة! ❌', 'error');
                    } else {
                        showNotification('هذا الإيميل غير مسجل! يرجى إنشاء حساب جديد أولاً 📧', 'error');
                    }
                }
                
            } catch (error) {
                console.error('Email Login Error:', error);
                showNotification('خطأ في تسجيل الدخول ❌', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleEmailRegister() {
            showRegistrationModal();
        }

        function handleLoginSuccess(userData, isNewUser = false) {
            // Set current user and admin status
            currentUser = userData;
            isAdmin = userData.isAdmin || false;
            
            // Hide login form and show main app
            loginContainer.style.display = 'none';
            mainApp.classList.remove('hidden');
            
            // Update user display
            userNameDisplay.textContent = userData.name;
            
            // Show user profile picture if available
            if (userData.photoURL) {
                document.getElementById('userProfilePic').src = userData.photoURL;
                document.getElementById('userProfileContainer').classList.remove('hidden');
            }
            
            // Initialize the app
            updateCartBadge();
            navigateToPage('categories');
            
            // Show success notification
            const message = isNewUser 
                ? `تم إنشاء الحساب بنجاح! مرحباً ${userData.name} 🎉`
                : userData.isAdmin 
                    ? `مرحباً بك أيها المدير ${userData.name}! 👑`
                    : `مرحباً بعودتك ${userData.name}! 👋`;
            
            setTimeout(() => {
                showNotification(message, 'success');
            }, 500);
        }

        function handleLogout() {
            // Reset state
            currentUser = null;
            isAdmin = false;
            cart = [];
            
            // Hide main app and show login
            mainApp.classList.add('hidden');
            loginContainer.style.display = 'block';
            
            // Clear form
            loginEmail.value = '';
            loginPassword.value = '';
            
            // Update UI
            updateCartBadge();
            
            showNotification('تم تسجيل الخروج بنجاح! 👋', 'info');
        }

        function updateCartBadge() {
            cartBadge.textContent = cart.length;
        }

        function navigateToPage(page) {
            // Hide all pages
            document.getElementById('categoriesPage').classList.add('hidden');
            document.getElementById('productsPage').classList.add('hidden');
            document.getElementById('adminSettingsPage').classList.add('hidden');
            
            // Show selected page
            currentPage = page;
            
            switch(page) {
                case 'categories':
                    document.getElementById('categoriesPage').classList.remove('hidden');
                    renderCategories();
                    break;
                case 'products':
                    document.getElementById('productsPage').classList.remove('hidden');
                    renderProducts();
                    break;
                case 'settings':
                    if (isAdmin) {
                        document.getElementById('adminSettingsPage').classList.remove('hidden');
                        renderAdminSettings();
                    } else {
                        showNotification('ليس لديك صلاحية للوصول لهذه الصفحة! ⚠️', 'error');
                        navigateToPage('categories');
                    }
                    break;
            }
        }

        function renderCategories() {
            const grid = document.getElementById('categoriesGrid');
            grid.innerHTML = '';

            if (categories.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center text-gray-300 py-12">
                        <i class="fas fa-store text-6xl mb-6 text-white text-opacity-50"></i>
                        <h3 class="text-xl font-bold text-white mb-3">ابدأ رحلتك التجارية! 🚀</h3>
                        <p class="text-lg mb-4">لا توجد أقسام حالياً في متجرك</p>
                    </div>
                `;
                return;
            }

            categories.forEach(category => {
                // Count products in this category
                const productCount = products.filter(p => p.categoryId === category.id).length;
                
                const card = document.createElement('div');
                card.className = 'glass p-4 rounded-xl cursor-pointer relative transform transition-all duration-300 hover:scale-105 hover:shadow-2xl aspect-square flex items-center justify-center';
                card.style.background = `linear-gradient(135deg, ${category.color}50, ${category.color}30)`;
                card.style.border = `2px solid ${category.color}60`;
                card.style.minHeight = '160px';
                card.style.maxHeight = '160px';
                
                card.innerHTML = `
                    <div class="text-center">
                        <div class="mb-3 relative">
                            <i class="${category.icon} text-3xl text-white drop-shadow-lg"></i>
                            <div class="absolute -top-2 -right-2 bg-white bg-opacity-20 backdrop-blur-sm rounded-full w-6 h-6 flex items-center justify-center">
                                <span class="text-white text-xs font-bold">${productCount}</span>
                            </div>
                        </div>
                        <h3 class="text-base font-bold text-white mb-2 drop-shadow-md">${category.name}</h3>
                        <p class="text-white text-opacity-90 text-sm">${productCount} منتج</p>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    selectedCategory = category;
                    navigateToPage('products');
                });
                
                grid.appendChild(card);
            });

            // Add admin-only cards
            if (isAdmin) {
                // Settings card
                const settingsCard = document.createElement('div');
                settingsCard.className = 'glass p-4 rounded-xl cursor-pointer relative transform transition-all duration-300 hover:scale-105 hover:shadow-2xl aspect-square flex items-center justify-center';
                settingsCard.style.background = 'linear-gradient(135deg, #6366F150, #6366F130)';
                settingsCard.style.border = '2px solid #6366F160';
                settingsCard.style.minHeight = '160px';
                settingsCard.style.maxHeight = '160px';
                
                settingsCard.innerHTML = `
                    <div class="text-center">
                        <div class="mb-3 relative">
                            <i class="fas fa-cog text-3xl text-white drop-shadow-lg"></i>
                            <div class="absolute -top-2 -right-2 bg-red-500 rounded-full w-6 h-6 flex items-center justify-center">
                                <i class="fas fa-crown text-white text-xs"></i>
                            </div>
                        </div>
                        <h3 class="text-base font-bold text-white mb-2 drop-shadow-md">الإعدادات</h3>
                        <p class="text-white text-opacity-90 text-sm">إدارة النظام</p>
                    </div>
                `;
                
                settingsCard.addEventListener('click', () => {
                    navigateToPage('settings');
                });
                
                grid.appendChild(settingsCard);
            }
        }

        function renderProducts() {
            if (!selectedCategory) return;
            
            // Update category header
            document.getElementById('categoryTitle').textContent = selectedCategory.name;
            const categoryProducts = products.filter(p => p.categoryId === selectedCategory.id);
            document.getElementById('categorySubtitle').textContent = `${categoryProducts.length} منتج متاح`;
            
            // Render products
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';
            
            if (categoryProducts.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center text-gray-300 py-12">
                        <i class="${selectedCategory.icon} text-6xl mb-6 text-white text-opacity-50"></i>
                        <h3 class="text-xl font-bold text-white mb-3">لا توجد منتجات حالياً</h3>
                        <p class="text-lg mb-4">في قسم ${selectedCategory.name}</p>
                    </div>
                `;
                return;
            }
            
            categoryProducts.forEach(product => {
                const finalPrice = product.price - (product.price * product.discount / 100);
                
                const card = document.createElement('div');
                card.className = 'glass p-4 rounded-xl transform transition-all duration-300 hover:scale-105 hover:shadow-2xl';
                
                card.innerHTML = `
                    <div class="text-center">
                        <div class="text-4xl mb-3">${product.image}</div>
                        <h3 class="text-lg font-bold text-white mb-2">${product.name}</h3>
                        
                        <div class="mb-3">
                            ${product.discount > 0 ? `
                                <div class="flex items-center justify-center gap-2">
                                    <span class="text-red-400 line-through text-sm">${product.price.toFixed(2)} ج.م</span>
                                    <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">-${product.discount}%</span>
                                </div>
                                <div class="text-green-400 font-bold text-xl">${finalPrice.toFixed(2)} ج.م</div>
                            ` : `
                                <div class="text-green-400 font-bold text-xl">${product.price.toFixed(2)} ج.م</div>
                            `}
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex items-center justify-center gap-2 text-sm">
                                <i class="fas fa-box text-blue-400"></i>
                                <span class="text-white">متوفر: ${product.stock}</span>
                            </div>
                        </div>
                        
                        <button onclick="addToCart(${product.id})" class="w-full bg-gradient-to-r from-green-500 to-green-600 p-3 rounded-lg text-white hover:from-green-600 hover:to-green-700 transition-all font-medium ${product.stock === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${product.stock === 0 ? 'disabled' : ''}>
                            <i class="fas fa-cart-plus ml-2"></i>
                            ${product.stock === 0 ? 'غير متوفر' : 'أضف للسلة'}
                        </button>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        function renderAdminSettings() {
            // Update all settings inputs
            document.getElementById('storeNameSetting').value = storeName;
            document.getElementById('adminEmailSetting').value = adminEmail;
            document.getElementById('adminPasswordSetting').value = adminPassword;
            document.getElementById('walletNumberSetting').value = walletNumber;
            document.getElementById('walletProviderSetting').value = walletProvider;
            
            // Update notification settings
            document.getElementById('newOrderNotifications').checked = notificationsEnabled;
            document.getElementById('notificationSound').value = notificationSound;
            document.getElementById('whatsappNumber').value = whatsappNumber;
            
            // Update statistics
            document.getElementById('categoriesCount').textContent = categories.length;
            document.getElementById('productsCount').textContent = products.length;
            document.getElementById('availableProductsCount').textContent = products.filter(p => p.stock > 0).length;
            
            // Update management statistics
            document.getElementById('categoriesCountManage').textContent = categories.length;
            document.getElementById('productsCountManage').textContent = products.length;
            document.getElementById('outOfStockCount').textContent = products.filter(p => p.stock === 0).length;
            
            // Update orders statistics
            document.getElementById('totalOrdersCount').textContent = orders.length;
            document.getElementById('pendingOrdersCount').textContent = orders.filter(o => o.status === 'pending').length;
            document.getElementById('confirmedOrdersCount').textContent = orders.filter(o => o.status === 'confirmed').length;
        }

        function updateStoreName() {
            const newStoreName = document.getElementById('storeNameSetting').value.trim();
            if (!newStoreName) {
                showNotification('يرجى إدخال اسم المتجر! ⚠️', 'error');
                return;
            }
            
            storeName = newStoreName;
            
            // Update store name in all places
            document.getElementById('storeNameHeader').textContent = storeName;
            document.getElementById('pageTitle').textContent = `تسجيل الدخول - ${storeName}`;
            
            // Force save to localStorage
            saveToLocalStorage();
            
            // Verify save worked
            setTimeout(() => {
                const savedData = localStorage.getItem('bakalatAlhayData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.storeName === storeName) {
                        showNotification(`تم تحديث اسم المتجر إلى: ${storeName} ✅`, 'success');
                    } else {
                        showNotification('خطأ في حفظ البيانات! ❌', 'error');
                    }
                }
            }, 100);
        }

        function updateAdminEmail() {
            const newEmail = document.getElementById('adminEmailSetting').value.trim();
            if (!newEmail || !isValidEmail(newEmail)) {
                showNotification('يرجى إدخال إيميل صحيح! ⚠️', 'error');
                return;
            }
            
            adminEmail = newEmail;
            
            // Force save to localStorage
            saveToLocalStorage();
            
            // Verify save worked
            setTimeout(() => {
                const savedData = localStorage.getItem('bakalatAlhayData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.adminEmail === adminEmail) {
                        showNotification(`تم تحديث إيميل المدير إلى: ${adminEmail} ✅`, 'success');
                    } else {
                        showNotification('خطأ في حفظ البيانات! ❌', 'error');
                    }
                }
            }, 100);
        }

        function updateAdminPassword() {
            const newPassword = document.getElementById('adminPasswordSetting').value.trim();
            if (!newPassword) {
                showNotification('يرجى إدخال كلمة مرور! ⚠️', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('كلمة المرور يجب أن تكون 6 أحرف على الأقل! ⚠️', 'error');
                return;
            }
            
            adminPassword = newPassword;
            
            // Force save to localStorage
            saveToLocalStorage();
            
            // Verify save worked
            setTimeout(() => {
                const savedData = localStorage.getItem('bakalatAlhayData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.adminPassword === adminPassword) {
                        showNotification('تم تحديث كلمة مرور المدير بنجاح! ✅', 'success');
                    } else {
                        showNotification('خطأ في حفظ البيانات! ❌', 'error');
                    }
                }
            }, 100);
        }

        function updateWalletSettings() {
            const newWalletNumber = document.getElementById('walletNumberSetting').value.trim();
            const newWalletProvider = document.getElementById('walletProviderSetting').value;
            
            if (!newWalletNumber) {
                showNotification('يرجى إدخال رقم المحفظة! ⚠️', 'error');
                return;
            }
            
            if (!/^01\d{9}$/.test(newWalletNumber)) {
                showNotification('رقم المحفظة يجب أن يبدأ بـ 01 ويتكون من 11 رقم! ⚠️', 'error');
                return;
            }
            
            walletNumber = newWalletNumber;
            walletProvider = newWalletProvider;
            
            const providerNames = {
                'vodafone': 'فودافون كاش',
                'etisalat': 'اتصالات كاش',
                'orange': 'أورانج كاش'
            };
            
            // Force save to localStorage
            saveToLocalStorage();
            
            // Verify save worked
            setTimeout(() => {
                const savedData = localStorage.getItem('bakalatAlhayData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.walletNumber === walletNumber && data.walletProvider === walletProvider) {
                        showNotification(`تم تحديث المحفظة إلى: ${walletNumber} (${providerNames[walletProvider]}) ✅`, 'success');
                    } else {
                        showNotification('خطأ في حفظ البيانات! ❌', 'error');
                    }
                }
            }, 100);
        }

        function showOrdersManagementModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="glass-dark p-6 rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="text-center mb-6">
                        <i class="fas fa-clipboard-list text-4xl text-cyan-400 mb-3"></i>
                        <h2 class="text-2xl font-bold text-white">إدارة الطلبات</h2>
                        <p class="text-gray-300 text-sm mt-2">متابعة وإدارة جميع طلبات العملاء</p>
                    </div>
                    
                    <!-- Orders List -->
                    <div id="ordersList" class="space-y-4 mb-6">
                        ${orders.length === 0 ? `
                            <div class="text-center text-gray-300 py-12">
                                <i class="fas fa-inbox text-6xl mb-4 text-white text-opacity-50"></i>
                                <h3 class="text-xl font-bold text-white mb-3">لا توجد طلبات حالياً</h3>
                                <p class="text-lg">عندما يقوم العملاء بالطلب، ستظهر هنا</p>
                            </div>
                        ` : orders.map(order => `
                            <div class="glass p-4 rounded-lg">
                                <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-2">
                                            <span class="order-status-${order.status} text-white px-3 py-1 rounded-full text-sm font-bold">
                                                ${getOrderStatusText(order.status)}
                                            </span>
                                            <span class="text-gray-300 text-sm">طلب #${order.id}</span>
                                            <span class="text-gray-300 text-sm">${new Date(order.date).toLocaleDateString('ar-EG')}</span>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <h4 class="text-white font-bold mb-1">معلومات العميل:</h4>
                                                <p class="text-gray-300 text-sm">الاسم: ${order.customerName}</p>
                                                <p class="text-gray-300 text-sm">الهاتف: ${order.customerPhone}</p>
                                                <p class="text-gray-300 text-sm">المحفظة: ${order.senderWallet}</p>
                                            </div>
                                            
                                            <div>
                                                <h4 class="text-white font-bold mb-1">العنوان:</h4>
                                                <p class="text-gray-300 text-sm">${order.address}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <h4 class="text-white font-bold mb-2">المنتجات:</h4>
                                            <div class="flex flex-wrap gap-2">
                                                ${order.items.map(item => `
                                                    <span class="bg-white bg-opacity-10 text-white px-2 py-1 rounded text-sm">
                                                        ${item.image} ${item.name} × ${item.quantity}
                                                    </span>
                                                `).join('')}
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3 flex items-center justify-between">
                                            <span class="text-green-400 font-bold text-lg">المجموع: ${order.total.toFixed(2)} ج.م</span>
                                            <div class="flex gap-2">
                                                ${order.status === 'pending' ? `
                                                    <button onclick="confirmOrderWithImage(${order.id})" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition-all">
                                                        <i class="fas fa-check ml-1"></i>
                                                        تأكيد مع صورة
                                                    </button>
                                                    <button onclick="cancelOrder(${order.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-all">
                                                        <i class="fas fa-times ml-1"></i>
                                                        إلغاء
                                                    </button>
                                                ` : order.status === 'confirmed' ? `
                                                    <button onclick="markAsDelivered(${order.id})" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm transition-all">
                                                        <i class="fas fa-truck ml-1"></i>
                                                        تم التسليم
                                                    </button>
                                                    ${order.transferImage ? `
                                                        <button onclick="viewTransferImage('${order.transferImage}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-all">
                                                            <i class="fas fa-image ml-1"></i>
                                                            عرض الصورة
                                                        </button>
                                                    ` : ''}
                                                ` : order.status === 'delivered' && order.transferImage ? `
                                                    <button onclick="viewTransferImage('${order.transferImage}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-all">
                                                        <i class="fas fa-image ml-1"></i>
                                                        عرض الصورة
                                                    </button>
                                                ` : ''}
                                                <button onclick="deleteOrder(${order.id})" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition-all">
                                                    <i class="fas fa-trash ml-1"></i>
                                                    حذف
                                                </button>
                                            </div>
                                        </div>
                                        
                                        ${order.notes ? `
                                            <div class="mt-2">
                                                <span class="text-gray-400 text-sm">ملاحظات: ${order.notes}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="text-center">
                        <button onclick="this.closest('.fixed').remove()" class="bg-gradient-to-r from-gray-500 to-gray-600 px-6 py-3 rounded-lg text-white hover:from-gray-600 hover:to-gray-700 transition-all font-medium">
                            <i class="fas fa-times ml-2"></i>
                            إغلاق
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add image preview functionality
            document.getElementById('transferImageUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('previewTransferImg').src = e.target.result;
                        document.getElementById('transferImagePreview').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function removeTransferImage() {
            document.getElementById('transferImageUpload').value = '';
            document.getElementById('transferImagePreview').classList.add('hidden');
            document.getElementById('previewTransferImg').src = '';
        }

        function getOrderStatusText(status) {
            const statusTexts = {
                'pending': 'معلق',
                'confirmed': 'مؤكد',
                'delivered': 'مسلم',
                'cancelled': 'ملغي'
            };
            return statusTexts[status] || status;
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.stock === 0) {
                showNotification('المنتج غير متوفر! ❌', 'error');
                return;
            }
            
            // Check if product already in cart
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price - (product.price * product.discount / 100),
                    quantity: 1,
                    image: product.image
                });
            }
            
            // Update stock
            product.stock -= 1;
            saveToLocalStorage();
            
            updateCartBadge();
            showNotification(`تم إضافة ${product.name} للسلة! 🛒`, 'success');
            
            // Re-render products to update stock display
            if (currentPage === 'products') {
                renderProducts();
            }
        }

        function showCart() {
            if (cart.length === 0) {
                showNotification('السلة فارغة! 🛒', 'info');
                return;
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="glass-dark p-6 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="text-center mb-6">
                        <i class="fas fa-shopping-cart text-4xl text-green-400 mb-3"></i>
                        <h2 class="text-2xl font-bold text-white">سلة التسوق</h2>
                        <p class="text-gray-300 text-sm mt-2">مراجعة طلبك قبل الإرسال</p>
                    </div>
                    
                    <!-- Cart Items -->
                    <div class="space-y-3 mb-6">
                        ${cart.map((item, index) => `
                            <div class="glass p-4 rounded-lg flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">${item.image}</span>
                                    <div>
                                        <h4 class="text-white font-medium">${item.name}</h4>
                                        <p class="text-gray-300 text-sm">${item.price.toFixed(2)} ج.م × ${item.quantity}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="updateCartQuantity(${index}, -1)" class="bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center transition-all">
                                        <i class="fas fa-minus text-sm"></i>
                                    </button>
                                    <span class="text-white font-bold w-8 text-center">${item.quantity}</span>
                                    <button onclick="updateCartQuantity(${index}, 1)" class="bg-green-500 hover:bg-green-600 text-white w-8 h-8 rounded-full flex items-center justify-center transition-all">
                                        <i class="fas fa-plus text-sm"></i>
                                    </button>
                                    <button onclick="removeFromCart(${index})" class="bg-gray-500 hover:bg-gray-600 text-white w-8 h-8 rounded-full flex items-center justify-center transition-all ml-2">
                                        <i class="fas fa-trash text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Total -->
                    <div class="glass p-4 rounded-lg mb-6">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-lg font-medium">المجموع الكلي:</span>
                            <span class="text-green-400 text-2xl font-bold">${total.toFixed(2)} ج.م</span>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-3">
                        <button onclick="proceedToCheckout()" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 p-3 rounded-lg text-white hover:from-green-600 hover:to-green-700 transition-all font-medium">
                            <i class="fas fa-credit-card ml-2"></i>
                            إتمام الطلب
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="bg-gradient-to-r from-gray-500 to-gray-600 p-3 rounded-lg text-white hover:from-gray-600 hover:to-gray-700 transition-all font-medium">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add image preview functionality
            document.getElementById('transferImageUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('previewTransferImg').src = e.target.result;
                        document.getElementById('transferImagePreview').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function removeTransferImage() {
            document.getElementById('transferImageUpload').value = '';
            document.getElementById('transferImagePreview').classList.add('hidden');
            document.getElementById('previewTransferImg').src = '';
        }

        function updateCartQuantity(index, change) {
            const item = cart[index];
            const product = products.find(p => p.id === item.id);
            
            if (change > 0) {
                // Check if we have enough stock
                if (product.stock <= 0) {
                    showNotification('لا يوجد مخزون كافي! ❌', 'error');
                    return;
                }
                item.quantity += 1;
                product.stock -= 1;
            } else {
                item.quantity -= 1;
                product.stock += 1;
                
                if (item.quantity <= 0) {
                    cart.splice(index, 1);
                }
            }
            
            saveToLocalStorage();
            updateCartBadge();
            
            // Close and reopen cart modal
            document.querySelector('.fixed.inset-0').remove();
            if (cart.length > 0) {
                showCart();
            }
        }

        function removeFromCart(index) {
            const item = cart[index];
            const product = products.find(p => p.id === item.id);
            
            // Return stock
            product.stock += item.quantity;
            
            // Remove from cart
            cart.splice(index, 1);
            
            saveToLocalStorage();
            updateCartBadge();
            
            // Close and reopen cart modal
            document.querySelector('.fixed.inset-0').remove();
            if (cart.length > 0) {
                showCart();
            } else {
                showNotification('تم إفراغ السلة! 🛒', 'info');
            }
        }

        function proceedToCheckout() {
            if (cart.length === 0) {
                showNotification('السلة فارغة! 🛒', 'error');
                return;
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="glass-dark p-6 rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                    <div class="text-center mb-6">
                        <i class="fas fa-credit-card text-4xl text-blue-400 mb-3"></i>
                        <h2 class="text-2xl font-bold text-white">إتمام الطلب</h2>
                        <p class="text-gray-300 text-sm mt-2">أدخل بياناتك لإتمام عملية الشراء</p>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Customer Name -->
                        <div>
                            <label class="block text-white text-sm font-medium mb-2">
                                <i class="fas fa-user ml-2"></i>
                                الاسم الكامل *
                            </label>
                            <input type="text" id="customerName" placeholder="أدخل اسمك الكامل" 
                                   class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                        </div>
                        
                        <!-- Customer Phone -->
                        <div>
                            <label class="block text-white text-sm font-medium mb-2">
                                <i class="fas fa-phone ml-2"></i>
                                رقم الهاتف *
                            </label>
                            <input type="tel" id="customerPhone" placeholder="01xxxxxxxxx" 
                                   class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                        </div>
                        
                        <!-- Customer Address -->
                        <div>
                            <label class="block text-white text-sm font-medium mb-2">
                                <i class="fas fa-map-marker-alt ml-2"></i>
                                العنوان التفصيلي *
                            </label>
                            <textarea id="customerAddress" placeholder="أدخل عنوانك بالتفصيل (المحافظة، المدينة، الحي، الشارع، رقم المبنى، الدور، الشقة)" 
                                      rows="4" class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all resize-none"></textarea>
                        </div>
                        
                        <!-- Sender Wallet -->
                        <div>
                            <label class="block text-white text-sm font-medium mb-2">
                                <i class="fas fa-wallet ml-2"></i>
                                رقم محفظتك (للتحويل منها) *
                            </label>
                            <input type="tel" id="senderWallet" placeholder="01xxxxxxxxx" 
                                   class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                        </div>
                        
                        <!-- Payment Info -->
                        <div class="glass p-4 rounded-lg">
                            <h4 class="text-white font-bold mb-2">معلومات الدفع:</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-300">المجموع:</span>
                                    <span class="text-green-400 font-bold">${total.toFixed(2)} ج.م</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">التحويل إلى:</span>
                                    <span class="text-blue-400 font-bold">${walletNumber}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">نوع المحفظة:</span>
                                    <span class="text-purple-400 font-bold">${walletProvider === 'vodafone' ? 'فودافون كاش' : walletProvider === 'etisalat' ? 'اتصالات كاش' : 'أورانج كاش'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Transfer Image Upload -->
                        <div>
                            <label class="block text-white text-sm font-medium mb-2">
                                <i class="fas fa-image ml-2"></i>
                                صورة إيصال التحويل *
                            </label>
                            <input type="file" id="transferImageUpload" accept="image/*" 
                                   class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                            <p class="text-gray-400 text-xs mt-1">ارفق صورة إيصال التحويل من محفظة فودافون كاش</p>
                        </div>
                        
                        <!-- Image Preview -->
                        <div id="transferImagePreview" class="hidden">
                            <label class="block text-white text-sm font-medium mb-2">معاينة الصورة:</label>
                            <div class="relative">
                                <img id="previewTransferImg" src="" alt="معاينة إيصال التحويل" class="w-full h-48 object-cover rounded-lg border-2 border-white border-opacity-30">
                                <button type="button" onclick="removeTransferImage()" class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center transition-all">
                                    <i class="fas fa-times text-sm"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Order Notes -->
                        <div>
                            <label class="block text-white text-sm font-medium mb-2">
                                <i class="fas fa-sticky-note ml-2"></i>
                                ملاحظات إضافية (اختياري)
                            </label>
                            <textarea id="orderNotes" placeholder="أي ملاحظات خاصة بالطلب..." 
                                      rows="2" class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all resize-none"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="submitOrder()" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 p-3 rounded-lg text-white hover:from-green-600 hover:to-green-700 transition-all font-medium">
                            <i class="fas fa-paper-plane ml-2"></i>
                            إرسال الطلب
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="bg-gradient-to-r from-gray-500 to-gray-600 p-3 rounded-lg text-white hover:from-gray-600 hover:to-gray-700 transition-all font-medium">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add image preview functionality
            document.getElementById('transferImageUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('previewTransferImg').src = e.target.result;
                        document.getElementById('transferImagePreview').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function removeTransferImage() {
            document.getElementById('transferImageUpload').value = '';
            document.getElementById('transferImagePreview').classList.add('hidden');
            document.getElementById('previewTransferImg').src = '';
        }

        function submitOrder() {
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const customerAddress = document.getElementById('customerAddress').value.trim();
            const senderWallet = document.getElementById('senderWallet').value.trim();
            const orderNotes = document.getElementById('orderNotes').value.trim();
            const transferImageFile = document.getElementById('transferImageUpload').files[0];

            // Validation
            if (!customerName) {
                showNotification('يرجى إدخال الاسم الكامل! ⚠️', 'error');
                return;
            }

            if (!customerPhone || !/^01\d{9}$/.test(customerPhone)) {
                showNotification('يرجى إدخال رقم هاتف صحيح! ⚠️', 'error');
                return;
            }

            if (!customerAddress) {
                showNotification('يرجى إدخال العنوان التفصيلي! ⚠️', 'error');
                return;
            }

            if (!senderWallet || !/^01\d{9}$/.test(senderWallet)) {
                showNotification('يرجى إدخال رقم محفظة صحيح! ⚠️', 'error');
                return;
            }

            if (!transferImageFile) {
                showNotification('يرجى إرفاق صورة إيصال التحويل! ⚠️', 'error');
                return;
            }

            // Process the image
            const reader = new FileReader();
            reader.onload = function(e) {
                // Create order
                const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const newOrder = {
                    id: orderIdCounter++,
                    customerName,
                    customerPhone,
                    address: customerAddress,
                    senderWallet,
                    items: [...cart],
                    total,
                    notes: orderNotes,
                    transferImage: e.target.result,
                    status: 'pending',
                    date: new Date().toISOString()
                };

                // Add to orders database
                orders.push(newOrder);
                
                // Clear cart
                cart = [];
                
                // Save to database
                saveToLocalStorage();
                
                // Update UI
                updateCartBadge();
                
                // Play notification sound for new order (if admin is logged in)
                if (isAdmin && notificationsEnabled) {
                    playNotificationSound(notificationSound);
                    setTimeout(() => {
                        showNotification(`🔔 طلب جديد وارد! رقم الطلب: #${newOrder.id}`, 'info');
                    }, 1000);
                }
                
                // Send WhatsApp notification if number is configured
                if (whatsappNumber && notificationsEnabled) {
                    sendWhatsAppNotification(newOrder);
                }
                
                // Close modal
                document.querySelector('.fixed.inset-0').remove();
                
                // Show success message
                showNotification(`تم إرسال طلبك بنجاح مع صورة الإيصال! رقم الطلب: #${newOrder.id} 🎉`, 'success');
            };
            
            reader.readAsDataURL(transferImageFile);
        }

        function showRegistrationModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="glass-dark p-8 rounded-2xl max-w-md w-full">
                    <div class="text-center mb-8">
                        <i class="fas fa-user-plus text-6xl text-blue-400 mb-4"></i>
                        <h2 class="text-3xl font-bold text-white mb-2">إنشاء حساب جديد</h2>
                        <p class="text-gray-300">أدخل بياناتك لإنشاء حساب جديد</p>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Name Input -->
                        <div class="input-group">
                            <input type="text" id="registerName" placeholder="الاسم الكامل" 
                                   class="w-full p-4 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                            <i class="fas fa-user input-icon"></i>
                        </div>
                        
                        <!-- Email Input -->
                        <div class="input-group">
                            <input type="email" id="registerEmail" placeholder="البريد الإلكتروني" 
                                   class="w-full p-4 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                            <i class="fas fa-envelope input-icon"></i>
                        </div>
                        
                        <!-- Password Input -->
                        <div class="input-group">
                            <input type="password" id="registerPassword" placeholder="كلمة المرور (6 أحرف على الأقل)" 
                                   class="w-full p-4 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                            <i class="fas fa-lock input-icon"></i>
                            <i class="fas fa-eye password-toggle" id="toggleRegisterPassword"></i>
                        </div>
                        
                        <!-- Confirm Password Input -->
                        <div class="input-group">
                            <input type="password" id="confirmPassword" placeholder="تأكيد كلمة المرور" 
                                   class="w-full p-4 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                            <i class="fas fa-lock input-icon"></i>
                            <i class="fas fa-eye password-toggle" id="toggleConfirmPassword"></i>
                        </div>
                        
                        <!-- Terms Checkbox -->
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="acceptTerms" class="w-5 h-5 rounded border-2 border-white border-opacity-30 bg-white bg-opacity-20 text-blue-500 focus:ring-blue-400">
                            <label for="acceptTerms" class="text-gray-300 text-sm">
                                أوافق على 
                                <a href="#" class="text-blue-400 hover:text-blue-300 transition-colors">شروط الاستخدام</a>
                                و
                                <a href="#" class="text-blue-400 hover:text-blue-300 transition-colors">سياسة الخصوصية</a>
                            </label>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="space-y-3">
                            <button id="createAccountBtn" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 p-4 rounded-lg text-white hover:from-blue-600 hover:to-blue-700 transition-all font-medium shadow-lg">
                                <i class="fas fa-user-plus ml-2"></i>
                                إنشاء الحساب
                            </button>
                            
                            <button id="backToLoginBtn" class="w-full bg-gradient-to-r from-gray-500 to-gray-600 p-4 rounded-lg text-white hover:from-gray-600 hover:to-gray-700 transition-all font-medium">
                                <i class="fas fa-arrow-right ml-2"></i>
                                العودة لتسجيل الدخول
                            </button>
                        </div>
                        
                        <!-- Loading Indicator -->
                        <div id="registerLoading" class="hidden text-center">
                            <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-blue-500">
                                <div class="loading-spinner mr-3"></div>
                                جاري إنشاء الحساب...
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners
            document.getElementById('toggleRegisterPassword').addEventListener('click', () => {
                toggleModalPasswordVisibility('registerPassword', 'toggleRegisterPassword');
            });
            
            document.getElementById('toggleConfirmPassword').addEventListener('click', () => {
                toggleModalPasswordVisibility('confirmPassword', 'toggleConfirmPassword');
            });
            
            document.getElementById('createAccountBtn').addEventListener('click', () => {
                processRegistration();
            });
            
            document.getElementById('backToLoginBtn').addEventListener('click', () => {
                modal.remove();
            });
            
            // Enter key support
            const inputs = modal.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        processRegistration();
                    }
                });
            });
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function toggleModalPasswordVisibility(inputId, toggleId) {
            const passwordInput = document.getElementById(inputId);
            const toggleIcon = document.getElementById(toggleId);
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash password-toggle';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye password-toggle';
            }
        }

        async function processRegistration() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            const acceptTerms = document.getElementById('acceptTerms').checked;

            // Validation
            if (!name) {
                showNotification('يرجى إدخال الاسم الكامل! ⚠️', 'error');
                return;
            }

            if (!email) {
                showNotification('يرجى إدخال البريد الإلكتروني! ⚠️', 'error');
                return;
            }

            if (!isValidEmail(email)) {
                showNotification('يرجى إدخال بريد إلكتروني صحيح! ⚠️', 'error');
                return;
            }

            if (!password) {
                showNotification('يرجى إدخال كلمة المرور! ⚠️', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('كلمة المرور يجب أن تكون 6 أحرف على الأقل! ⚠️', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showNotification('كلمة المرور وتأكيدها غير متطابقتين! ⚠️', 'error');
                return;
            }

            if (!acceptTerms) {
                showNotification('يرجى الموافقة على شروط الاستخدام! ⚠️', 'error');
                return;
            }

            // Check if user already exists
            const existingUser = registeredUsers.find(user => user.email === email);
            if (existingUser) {
                showNotification('هذا الإيميل مسجل مسبقاً! يرجى تسجيل الدخول بدلاً من ذلك 📧', 'error');
                return;
            }

            try {
                // Show loading
                document.getElementById('registerLoading').classList.remove('hidden');
                document.getElementById('createAccountBtn').disabled = true;
                document.getElementById('backToLoginBtn').disabled = true;
                
                // Simulate registration process
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Add new user to database
                const newUser = {
                    email: email,
                    password: password,
                    name: name
                };
                registeredUsers.push(newUser);
                saveToLocalStorage();
                
                // Create user data for login
                const userData = {
                    name: name,
                    email: email,
                    photoURL: null,
                    isAdmin: email === adminEmail
                };
                
                // Close modal
                document.querySelector('.fixed.inset-0').remove();
                
                // Login the user
                handleLoginSuccess(userData, true);
                
            } catch (error) {
                console.error('Registration Error:', error);
                showNotification('خطأ في إنشاء الحساب ❌', 'error');
            } finally {
                // Hide loading
                const loadingElement = document.getElementById('registerLoading');
                const createBtn = document.getElementById('createAccountBtn');
                const backBtn = document.getElementById('backToLoginBtn');
                
                if (loadingElement) loadingElement.classList.add('hidden');
                if (createBtn) createBtn.disabled = false;
                if (backBtn) backBtn.disabled = false;
            }
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Hide notification after 4 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 4000);
        }

        // Order management functions
        function confirmOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'confirmed';
                saveToLocalStorage();
                showNotification(`تم تأكيد الطلب #${orderId} ✅`, 'success');
                
                // Close and reopen modal to refresh
                document.querySelector('.fixed.inset-0').remove();
                showOrdersManagementModal();
            }
        }

        function cancelOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                // Return stock to products
                order.items.forEach(item => {
                    const product = products.find(p => p.id === item.id);
                    if (product) {
                        product.stock += item.quantity;
                    }
                });
                
                order.status = 'cancelled';
                saveToLocalStorage();
                showNotification(`تم إلغاء الطلب #${orderId} ❌`, 'info');
                
                // Close and reopen modal to refresh
                document.querySelector('.fixed.inset-0').remove();
                showOrdersManagementModal();
            }
        }

        function markAsDelivered(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'delivered';
                saveToLocalStorage();
                showNotification(`تم تسليم الطلب #${orderId} 🚚`, 'success');
                
                // Close and reopen modal to refresh
                document.querySelector('.fixed.inset-0').remove();
                showOrdersManagementModal();
            }
        }

        function deleteOrder(orderId) {
            if (confirm('هل أنت متأكد من حذف هذا الطلب؟')) {
                const orderIndex = orders.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    const order = orders[orderIndex];
                    
                    // Return stock to products if order was pending
                    if (order.status === 'pending') {
                        order.items.forEach(item => {
                            const product = products.find(p => p.id === item.id);
                            if (product) {
                                product.stock += item.quantity;
                            }
                        });
                    }
                    
                    orders.splice(orderIndex, 1);
                    saveToLocalStorage();
                    showNotification(`تم حذف الطلب #${orderId} 🗑️`, 'info');
                    
                    // Close and reopen modal to refresh
                    document.querySelector('.fixed.inset-0').remove();
                    if (orders.length > 0) {
                        showOrdersManagementModal();
                    }
                }
            }
        }

        // Notification settings functions
        function updateNotificationSettings() {
            notificationsEnabled = document.getElementById('newOrderNotifications').checked;
            notificationSound = document.getElementById('notificationSound').value;
            whatsappNumber = document.getElementById('whatsappNumber').value.trim();
            saveToLocalStorage();
            showNotification('تم تحديث إعدادات الإشعارات ✅', 'success');
        }

        function testNotification() {
            playNotificationSound(notificationSound);
            showNotification('🔔 تم تشغيل الإشعار التجريبي!', 'info');
        }

        // WhatsApp notification function
        function sendWhatsAppNotification(order) {
            const message = `🛒 *طلب جديد في ${storeName}*\n\n` +
                          `📋 رقم الطلب: #${order.id}\n` +
                          `👤 العميل: ${order.customerName}\n` +
                          `📱 الهاتف: ${order.customerPhone}\n` +
                          `💰 المبلغ: ${order.total.toFixed(2)} ج.م\n` +
                          `📍 العنوان: ${order.address}\n\n` +
                          `🛍️ المنتجات:\n${order.items.map(item => `• ${item.name} × ${item.quantity}`).join('\n')}`;
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;
            
            // Open WhatsApp in new tab
            window.open(whatsappUrl, '_blank');
        }

        // Categories Management Modal
        function showCategoriesManagementModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="glass-dark p-6 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="text-center mb-6">
                        <i class="fas fa-th-large text-4xl text-indigo-400 mb-3"></i>
                        <h2 class="text-2xl font-bold text-white">إدارة الأقسام</h2>
                        <p class="text-gray-300 text-sm mt-2">إضافة وتعديل وحذف أقسام المتجر</p>
                    </div>
                    
                    <!-- Add New Category -->
                    <div class="glass p-4 rounded-lg mb-6">
                        <h3 class="text-white font-bold mb-4">إضافة قسم جديد</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" id="newCategoryName" placeholder="اسم القسم" 
                                   class="p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-indigo-400 focus:outline-none transition-all">
                            <select id="newCategoryIcon" class="p-3 rounded-lg bg-white bg-opacity-20 text-white border border-white border-opacity-30 focus:border-indigo-400 focus:outline-none transition-all">
                                <option value="fas fa-box">📦 صندوق</option>
                                <option value="fas fa-apple-alt">🍎 تفاح</option>
                                <option value="fas fa-bread-slice">🍞 خبز</option>
                                <option value="fas fa-cheese">🧀 جبن</option>
                                <option value="fas fa-fish">🐟 سمك</option>
                                <option value="fas fa-cookie">🍪 بسكويت</option>
                                <option value="fas fa-seedling">🌱 نبات</option>
                                <option value="fas fa-leaf">🍃 ورقة</option>
                                <option value="fas fa-spray-can">🧴 رذاذ</option>
                                <option value="fas fa-graduation-cap">🎓 تخرج</option>
                                <option value="fas fa-tshirt">👕 قميص</option>
                                <option value="fas fa-baby">👶 طفل</option>
                            </select>
                            <select id="newCategoryColor" class="p-3 rounded-lg bg-white bg-opacity-20 text-white border border-white border-opacity-30 focus:border-indigo-400 focus:outline-none transition-all">
                                ${categoryColors.map((color, index) => `
                                    <option value="${color}" style="background-color: ${color};">لون ${index + 1}</option>
                                `).join('')}
                            </select>
                        </div>
                        <button onclick="addNewCategory()" class="mt-4 bg-gradient-to-r from-indigo-500 to-indigo-600 p-3 rounded-lg text-white hover:from-indigo-600 hover:to-indigo-700 transition-all font-medium">
                            <i class="fas fa-plus ml-2"></i>
                            إضافة القسم
                        </button>
                    </div>
                    
                    <!-- Categories List -->
                    <div class="space-y-3 mb-6">
                        ${categories.map(category => `
                            <div class="glass p-4 rounded-lg flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background: ${category.color};">
                                        <i class="${category.icon} text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-white font-bold">${category.name}</h4>
                                        <p class="text-gray-300 text-sm">${products.filter(p => p.categoryId === category.id).length} منتج</p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editCategory(${category.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded transition-all">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteCategory(${category.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded transition-all">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="text-center">
                        <button onclick="this.closest('.fixed').remove()" class="bg-gradient-to-r from-gray-500 to-gray-600 px-6 py-3 rounded-lg text-white hover:from-gray-600 hover:to-gray-700 transition-all font-medium">
                            <i class="fas fa-times ml-2"></i>
                            إغلاق
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add image preview functionality
            document.getElementById('transferImageUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('previewTransferImg').src = e.target.result;
                        document.getElementById('transferImagePreview').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function removeTransferImage() {
            document.getElementById('transferImageUpload').value = '';
            document.getElementById('transferImagePreview').classList.add('hidden');
            document.getElementById('previewTransferImg').src = '';
        }

        // Products Management Modal
        function showProductsManagementModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="glass-dark p-6 rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="text-center mb-6">
                        <i class="fas fa-boxes text-4xl text-teal-400 mb-3"></i>
                        <h2 class="text-2xl font-bold text-white">إدارة المنتجات</h2>
                        <p class="text-gray-300 text-sm mt-2">إضافة وتعديل وحذف منتجات المتجر</p>
                    </div>
                    
                    <!-- Add New Product -->
                    <div class="glass p-4 rounded-lg mb-6">
                        <h3 class="text-white font-bold mb-4">إضافة منتج جديد</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <input type="text" id="newProductName" placeholder="اسم المنتج" 
                                   class="p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-teal-400 focus:outline-none transition-all">
                            <input type="number" id="newProductPrice" placeholder="السعر" step="0.01"
                                   class="p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-teal-400 focus:outline-none transition-all">
                            <input type="number" id="newProductStock" placeholder="الكمية المتاحة"
                                   class="p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-teal-400 focus:outline-none transition-all">
                            <input type="number" id="newProductDiscount" placeholder="نسبة الخصم %" min="0" max="100"
                                   class="p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-teal-400 focus:outline-none transition-all">
                            <input type="text" id="newProductImage" placeholder="رمز المنتج (إيموجي)" maxlength="2"
                                   class="p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-teal-400 focus:outline-none transition-all">
                            <select id="newProductCategory" class="p-3 rounded-lg bg-white bg-opacity-20 text-white border border-white border-opacity-30 focus:border-teal-400 focus:outline-none transition-all">
                                <option value="">اختر القسم</option>
                                ${categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('')}
                            </select>
                        </div>
                        <button onclick="addNewProduct()" class="mt-4 bg-gradient-to-r from-teal-500 to-teal-600 p-3 rounded-lg text-white hover:from-teal-600 hover:to-teal-700 transition-all font-medium">
                            <i class="fas fa-plus ml-2"></i>
                            إضافة المنتج
                        </button>
                    </div>
                    
                    <!-- Products List -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        ${products.map(product => {
                            const category = categories.find(c => c.id === product.categoryId);
                            const finalPrice = product.price - (product.price * product.discount / 100);
                            return `
                                <div class="glass p-4 rounded-lg">
                                    <div class="flex items-center gap-4">
                                        <div class="text-3xl">${product.image}</div>
                                        <div class="flex-1">
                                            <h4 class="text-white font-bold">${product.name}</h4>
                                            <p class="text-gray-300 text-sm">القسم: ${category ? category.name : 'غير محدد'}</p>
                                            <div class="flex items-center gap-2 mt-1">
                                                ${product.discount > 0 ? `
                                                    <span class="text-red-400 line-through text-sm">${product.price.toFixed(2)} ج.م</span>
                                                    <span class="text-green-400 font-bold">${finalPrice.toFixed(2)} ج.م</span>
                                                    <span class="bg-red-500 text-white text-xs px-2 py-1 rounded">-${product.discount}%</span>
                                                ` : `
                                                    <span class="text-green-400 font-bold">${product.price.toFixed(2)} ج.م</span>
                                                `}
                                            </div>
                                            <p class="text-gray-300 text-sm">المخزون: ${product.stock}</p>
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <button onclick="editProduct(${product.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-all">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteProduct(${product.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-all">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="text-center">
                        <button onclick="this.closest('.fixed').remove()" class="bg-gradient-to-r from-gray-500 to-gray-600 px-6 py-3 rounded-lg text-white hover:from-gray-600 hover:to-gray-700 transition-all font-medium">
                            <i class="fas fa-times ml-2"></i>
                            إغلاق
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add image preview functionality
            document.getElementById('transferImageUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('previewTransferImg').src = e.target.result;
                        document.getElementById('transferImagePreview').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function removeTransferImage() {
            document.getElementById('transferImageUpload').value = '';
            document.getElementById('transferImagePreview').classList.add('hidden');
            document.getElementById('previewTransferImg').src = '';
        }

        // Category management functions
        window.addNewCategory = function() {
            const name = document.getElementById('newCategoryName').value.trim();
            const icon = document.getElementById('newCategoryIcon').value;
            const color = document.getElementById('newCategoryColor').value;
            
            if (!name) {
                showNotification('يرجى إدخال اسم القسم! ⚠️', 'error');
                return;
            }
            
            const newCategory = {
                id: Math.max(...categories.map(c => c.id), 0) + 1,
                name,
                icon,
                color
            };
            
            categories.push(newCategory);
            saveToLocalStorage();
            showNotification(`تم إضافة القسم "${name}" بنجاح! ✅`, 'success');
            
            // Refresh modal
            document.querySelector('.fixed.inset-0').remove();
            showCategoriesManagementModal();
        }

        window.editCategory = function(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            
            // Create edit modal
            const editModal = document.createElement('div');
            editModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60] p-4';
            editModal.innerHTML = `
                <div class="glass-dark p-6 rounded-2xl max-w-md w-full">
                    <div class="text-center mb-6">
                        <i class="fas fa-edit text-4xl text-blue-400 mb-3"></i>
                        <h2 class="text-2xl font-bold text-white">تعديل القسم</h2>
                    </div>
                    
                    <div class="space-y-4">
                        <input type="text" id="editCategoryName" value="${category.name}" placeholder="اسم القسم" 
                               class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                        
                        <select id="editCategoryIcon" class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                            <option value="fas fa-box" ${category.icon === 'fas fa-box' ? 'selected' : ''}>📦 صندوق</option>
                            <option value="fas fa-apple-alt" ${category.icon === 'fas fa-apple-alt' ? 'selected' : ''}>🍎 تفاح</option>
                            <option value="fas fa-bread-slice" ${category.icon === 'fas fa-bread-slice' ? 'selected' : ''}>🍞 خبز</option>
                            <option value="fas fa-cheese" ${category.icon === 'fas fa-cheese' ? 'selected' : ''}>🧀 جبن</option>
                            <option value="fas fa-fish" ${category.icon === 'fas fa-fish' ? 'selected' : ''}>🐟 سمك</option>
                            <option value="fas fa-cookie" ${category.icon === 'fas fa-cookie' ? 'selected' : ''}>🍪 بسكويت</option>
                            <option value="fas fa-seedling" ${category.icon === 'fas fa-seedling' ? 'selected' : ''}>🌱 نبات</option>
                            <option value="fas fa-leaf" ${category.icon === 'fas fa-leaf' ? 'selected' : ''}>🍃 ورقة</option>
                            <option value="fas fa-spray-can" ${category.icon === 'fas fa-spray-can' ? 'selected' : ''}>🧴 رذاذ</option>
                            <option value="fas fa-graduation-cap" ${category.icon === 'fas fa-graduation-cap' ? 'selected' : ''}>🎓 تخرج</option>
                            <option value="fas fa-tshirt" ${category.icon === 'fas fa-tshirt' ? 'selected' : ''}>👕 قميص</option>
                            <option value="fas fa-baby" ${category.icon === 'fas fa-baby' ? 'selected' : ''}>👶 طفل</option>
                        </select>
                        
                        <select id="editCategoryColor" class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                            ${categoryColors.map((color, index) => `
                                <option value="${color}" ${category.color === color ? 'selected' : ''} style="background-color: ${color};">لون ${index + 1}</option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="saveEditCategory(${categoryId})" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 p-3 rounded-lg text-white hover:from-blue-600 hover:to-blue-700 transition-all font-medium">
                            <i class="fas fa-save ml-2"></i>
                            حفظ التغييرات
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="bg-gradient-to-r from-gray-500 to-gray-600 p-3 rounded-lg text-white hover:from-gray-600 hover:to-gray-700 transition-all font-medium">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(editModal);
        }

        window.saveEditCategory = function(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            
            const newName = document.getElementById('editCategoryName').value.trim();
            const newIcon = document.getElementById('editCategoryIcon').value;
            const newColor = document.getElementById('editCategoryColor').value;
            
            if (!newName) {
                showNotification('يرجى إدخال اسم القسم! ⚠️', 'error');
                return;
            }
            
            category.name = newName;
            category.icon = newIcon;
            category.color = newColor;
            
            saveToLocalStorage();
            showNotification('تم تحديث القسم بنجاح! ✅', 'success');
            
            // Close edit modal and refresh main modal
            document.querySelectorAll('.fixed.inset-0').forEach(modal => modal.remove());
            showCategoriesManagementModal();
        }

        window.deleteCategory = function(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            const categoryProducts = products.filter(p => p.categoryId === categoryId);
            
            if (categoryProducts.length > 0) {
                showNotification('لا يمكن حذف القسم لأنه يحتوي على منتجات! ⚠️', 'error');
                return;
            }
            
            if (confirm(`هل أنت متأكد من حذف القسم "${category.name}"؟`)) {
                const index = categories.findIndex(c => c.id === categoryId);
                categories.splice(index, 1);
                saveToLocalStorage();
                showNotification('تم حذف القسم بنجاح! ✅', 'success');
                
                // Refresh modal
                document.querySelector('.fixed.inset-0').remove();
                showCategoriesManagementModal();
            }
        }

        // Product management functions
        window.addNewProduct = function() {
            const name = document.getElementById('newProductName').value.trim();
            const price = parseFloat(document.getElementById('newProductPrice').value);
            const stock = parseInt(document.getElementById('newProductStock').value);
            const discount = parseInt(document.getElementById('newProductDiscount').value) || 0;
            const image = document.getElementById('newProductImage').value.trim();
            const categoryId = parseInt(document.getElementById('newProductCategory').value);
            
            if (!name || !price || !stock || !categoryId || !image) {
                showNotification('يرجى ملء جميع الحقول المطلوبة! ⚠️', 'error');
                return;
            }
            
            const newProduct = {
                id: Math.max(...products.map(p => p.id), 0) + 1,
                name,
                price,
                stock,
                discount,
                image,
                categoryId
            };
            
            products.push(newProduct);
            saveToLocalStorage();
            showNotification(`تم إضافة المنتج "${name}" بنجاح! ✅`, 'success');
            
            // Refresh modal
            document.querySelector('.fixed.inset-0').remove();
            showProductsManagementModal();
        }

        window.editProduct = function(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Create edit modal
            const editModal = document.createElement('div');
            editModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60] p-4';
            editModal.innerHTML = `
                <div class="glass-dark p-6 rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                    <div class="text-center mb-6">
                        <i class="fas fa-edit text-4xl text-blue-400 mb-3"></i>
                        <h2 class="text-2xl font-bold text-white">تعديل المنتج</h2>
                    </div>
                    
                    <div class="space-y-4">
                        <input type="text" id="editProductName" value="${product.name}" placeholder="اسم المنتج" 
                               class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                        
                        <input type="number" id="editProductPrice" value="${product.price}" placeholder="السعر" step="0.01"
                               class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                        
                        <input type="number" id="editProductStock" value="${product.stock}" placeholder="الكمية المتاحة"
                               class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                        
                        <input type="number" id="editProductDiscount" value="${product.discount}" placeholder="نسبة الخصم %" min="0" max="100"
                               class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                        
                        <input type="text" id="editProductImage" value="${product.image}" placeholder="رمز المنتج (إيموجي)" maxlength="2"
                               class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                        
                        <select id="editProductCategory" class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white border border-white border-opacity-30 focus:border-blue-400 focus:outline-none transition-all">
                            <option value="">اختر القسم</option>
                            ${categories.map(cat => `<option value="${cat.id}" ${product.categoryId === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="saveEditProduct(${productId})" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 p-3 rounded-lg text-white hover:from-blue-600 hover:to-blue-700 transition-all font-medium">
                            <i class="fas fa-save ml-2"></i>
                            حفظ التغييرات
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="bg-gradient-to-r from-gray-500 to-gray-600 p-3 rounded-lg text-white hover:from-gray-600 hover:to-gray-700 transition-all font-medium">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(editModal);
        }

        window.saveEditProduct = function(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const newName = document.getElementById('editProductName').value.trim();
            const newPrice = parseFloat(document.getElementById('editProductPrice').value);
            const newStock = parseInt(document.getElementById('editProductStock').value);
            const newDiscount = parseInt(document.getElementById('editProductDiscount').value) || 0;
            const newImage = document.getElementById('editProductImage').value.trim();
            const newCategoryId = parseInt(document.getElementById('editProductCategory').value);
            
            if (!newName || !newPrice || !newStock || !newCategoryId || !newImage) {
                showNotification('يرجى ملء جميع الحقول المطلوبة! ⚠️', 'error');
                return;
            }
            
            product.name = newName;
            product.price = newPrice;
            product.stock = newStock;
            product.discount = newDiscount;
            product.image = newImage;
            product.categoryId = newCategoryId;
            
            saveToLocalStorage();
            showNotification('تم تحديث المنتج بنجاح! ✅', 'success');
            
            // Close edit modal and refresh main modal
            document.querySelectorAll('.fixed.inset-0').forEach(modal => modal.remove());
            showProductsManagementModal();
        }

        window.deleteProduct = function(productId) {
            const product = products.find(p => p.id === productId);
            
            if (confirm(`هل أنت متأكد من حذف المنتج "${product.name}"؟`)) {
                const index = products.findIndex(p => p.id === productId);
                products.splice(index, 1);
                saveToLocalStorage();
                showNotification('تم حذف المنتج بنجاح! ✅', 'success');
                
                // Refresh modal
                document.querySelector('.fixed.inset-0').remove();
                showProductsManagementModal();
            }
        }

        // Order management functions - make them global
        window.confirmOrder = function(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'confirmed';
                saveToLocalStorage();
                showNotification(`تم تأكيد الطلب #${orderId} ✅`, 'success');
                
                // Close and reopen modal to refresh
                document.querySelector('.fixed.inset-0').remove();
                showOrdersManagementModal();
            }
        }

        window.cancelOrder = function(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                // Return stock to products
                order.items.forEach(item => {
                    const product = products.find(p => p.id === item.id);
                    if (product) {
                        product.stock += item.quantity;
                    }
                });
                
                order.status = 'cancelled';
                saveToLocalStorage();
                showNotification(`تم إلغاء الطلب #${orderId} ❌`, 'info');
                
                // Close and reopen modal to refresh
                document.querySelector('.fixed.inset-0').remove();
                showOrdersManagementModal();
            }
        }

        window.markAsDelivered = function(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'delivered';
                saveToLocalStorage();
                showNotification(`تم تسليم الطلب #${orderId} 🚚`, 'success');
                
                // Close and reopen modal to refresh
                document.querySelector('.fixed.inset-0').remove();
                showOrdersManagementModal();
            }
        }

        window.deleteOrder = function(orderId) {
            if (confirm('هل أنت متأكد من حذف هذا الطلب؟')) {
                const orderIndex = orders.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    const order = orders[orderIndex];
                    
                    // Return stock to products if order was pending
                    if (order.status === 'pending') {
                        order.items.forEach(item => {
                            const product = products.find(p => p.id === item.id);
                            if (product) {
                                product.stock += item.quantity;
                            }
                        });
                    }
                    
                    orders.splice(orderIndex, 1);
                    saveToLocalStorage();
                    showNotification(`تم حذف الطلب #${orderId} 🗑️`, 'info');
                    
                    // Close and reopen modal to refresh
                    document.querySelector('.fixed.inset-0').remove();
                    if (orders.length > 0) {
                        showOrdersManagementModal();
                    }
                }
            }
        }

        window.confirmOrderWithImage = function(orderId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="glass-dark p-6 rounded-2xl max-w-md w-full">
                    <div class="text-center mb-6">
                        <i class="fas fa-camera text-4xl text-green-400 mb-3"></i>
                        <h2 class="text-2xl font-bold text-white">تأكيد الطلب</h2>
                        <p class="text-gray-300 text-sm mt-2">ارفق صورة إيصال التحويل</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-white text-sm font-medium mb-2">
                                <i class="fas fa-image ml-2"></i>
                                صورة إيصال التحويل *
                            </label>
                            <input type="file" id="transferImage" accept="image/*" 
                                   class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white border border-white border-opacity-30 focus:border-green-400 focus:outline-none transition-all">
                        </div>
                        
                        <div id="imagePreview" class="hidden">
                            <img id="previewImg" src="" alt="معاينة الصورة" class="w-full h-48 object-cover rounded-lg">
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="confirmOrderWithImageSubmit(${orderId})" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 p-3 rounded-lg text-white hover:from-green-600 hover:to-green-700 transition-all font-medium">
                            <i class="fas fa-check ml-2"></i>
                            تأكيد الطلب
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="bg-gradient-to-r from-gray-500 to-gray-600 p-3 rounded-lg text-white hover:from-gray-600 hover:to-gray-700 transition-all font-medium">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add image preview functionality
            document.getElementById('transferImage').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('previewImg').src = e.target.result;
                        document.getElementById('imagePreview').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        window.confirmOrderWithImageSubmit = function(orderId) {
            const fileInput = document.getElementById('transferImage');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('يرجى اختيار صورة إيصال التحويل! ⚠️', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const order = orders.find(o => o.id === orderId);
                if (order) {
                    order.status = 'confirmed';
                    order.transferImage = e.target.result;
                    saveToLocalStorage();
                    showNotification(`تم تأكيد الطلب #${orderId} مع صورة الإيصال ✅`, 'success');
                    
                    // Close modals and refresh
                    document.querySelectorAll('.fixed.inset-0').forEach(modal => modal.remove());
                    showOrdersManagementModal();
                }
            };
            reader.readAsDataURL(file);
        }

        window.viewTransferImage = function(imageData) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="max-w-4xl w-full">
                    <div class="text-center mb-4">
                        <h2 class="text-2xl font-bold text-white">صورة إيصال التحويل</h2>
                    </div>
                    <div class="bg-white rounded-lg p-4">
                        <img src="${imageData}" alt="إيصال التحويل" class="w-full h-auto max-h-[70vh] object-contain">
                    </div>
                    <div class="text-center mt-4">
                        <button onclick="this.closest('.fixed').remove()" class="bg-gradient-to-r from-gray-500 to-gray-600 px-6 py-3 rounded-lg text-white hover:from-gray-600 hover:to-gray-700 transition-all font-medium">
                            <i class="fas fa-times ml-2"></i>
                            إغلاق
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add image preview functionality
            document.getElementById('transferImageUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('previewTransferImg').src = e.target.result;
                        document.getElementById('transferImagePreview').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function removeTransferImage() {
            document.getElementById('transferImageUpload').value = '';
            document.getElementById('transferImagePreview').classList.add('hidden');
            document.getElementById('previewTransferImg').src = '';
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'979eb8b9f2407948',t:'MTc1NzAwMTg1NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
